<link rel="import" href="geosource-imports.html">

<dom-module id="geosource-app">
	<style>
		:host {
			font-size: 16px;
		}
		.drawer_title {
			/* layout properties for a local DOM element */
			@apply(--layout-horizontal --layout-center);
			margin: auto;
			text-transform: none;
			font-size: 1.3em;
		}
		.drawer_title, .dialog_title {
			font-size: 1.3em;
		}
		.drawer_title {
			/* layout properties for a local DOM element */
			@apply(--layout-horizontal --layout-center);
			margin: auto;
			text-transform: none;
		}
		.dialog_title {
			margin-right: auto;
			margin-left: 12px;
		}
		.button_title {
			margin: auto;
			font-size: 1.3em;
		}
		paper-toolbar::shadow .toolbar-tools paper-icon-button[icon=menu] {
			margin-left: 0px;
			margin-right: 0px;
		}
		paper-drawer-panel div[drawer] {
			background-color: #eee;
			box-shadow: rgba(0, 0, 0, 0.0980392) 0px 2px 4px, rgba(0, 0, 0, 0.0980392) 0px 0px 3px;
			overflow-x: auto;
		}
		geosource-posts {
			height: 100%;
		}
		geosource-metapost {
			padding: 10px;
			font-weight: 400;
			font-size: 16px;
			max-width: 300px;
		}
		#menu, #add, #add2, #user {
			position: absolute;
			z-index: 1;
		}
		#add {
			bottom: 8px;
			right: 8px;
			width: 40px;
			height: 40px;
		}
		#add2 {
			bottom: 56px;
			right: 8px;
			width: 40px;
			height: 40px;
		}
		#menu {
			top: 8px;
			left: 8px;
			color: #fff;
			background: #3f51b5;
			border-radius: 20px;
			margin: 0;
			padding: 0;
		}
		iron-icon {
			padding: 8px;
		}
		#geosource_button {
			@apply(--layout-horizontal);
			margin: 0;
			margin-right: 12px;
			margin-left: 4px;
			padding: 0;
		}
		paper-drawer-panel::shadow #drawer, paper-drawer-panel::shadow #scrim {
			z-index: 4;
		}
		geosource-dialog {
			z-index: 5;
		}
		paper-button {
			text-transform: none;
		}
		paper-button#login {
			color: #fff;
			background-color: #4184F3;
		}
		paper-button#logout {
			color: #000;
			background-color: #ccc;
		}
		paper-button#login, paper-button#logout {
			position: absolute;
			z-index: 1;
			right: 8px;
			top: 8px;
			margin: 0;
			box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
		}
		paper-button.signin {
			width: 100%;
			color: #fff;
			margin: 0;
			margin-bottom: 10px;
			padding: 0;
			overflow: hidden;
			white-space: nowrap;
			text-overflow: ellipsis;
			border: 1px solid;
			width: 250px;
		}
		paper-button.twitter {
			background-color: #4099FF;
			border-color: #3782D9;
		}
		paper-button.facebook {
			background-color: #3B5998;
			border-color: #334C81;
		}
		paper-button.google {
			background-color: #DC4E41;
			border-color: #BB4338;
		}
		social-media-icons {
			width: 32px;
			height: 32px;
			border-color: rgba(0,0,0,0.15);
			border-right-width: 1px;
			border-right-style: solid;
			padding: 8px;
			outline-color: rgba(255, 255, 255, 0.15);
			outline-width: 1px;
			outline-style: solid;
		}
		geosource-channel-creator {
			margin: 20px;
		}
	</style>
	<template>

		<platinum-sw-register>
			<platinum-sw-cache></platinum-sw-cache>
		</platinum-sw-register>

		<geosource-api-handler id="api"
			posts="{{posts}}"
			state="{{state}}"
			on-create-user="openCreateUserDialog">
		</geosource-api-handler>

		<geosource-post id="post"></geosource-post>

		<geosource-dialog id="create_channel">
			<paper-header-panel>
				<paper-toolbar>
					<div class="dialog_title">Create a Channel</div>
					<paper-icon-button icon="close" on-tap="toggleChannelDialog"></paper-icon-button>
				</paper-toolbar>
				<div main>
					<geosource-channel-creator
						on-submit="createChannel">
					</geosource-channel-creator>
				</div>
			</paper-header-panel>
		</geosource-dialog>

		<geosource-dialog id="create_post">
			<paper-header-panel>
				<paper-toolbar>
					<div class="dialog_title">Create a Post</div>
					<paper-icon-button icon="close" on-tap="togglePostDialog"></paper-icon-button>
				</paper-toolbar>
				<div main>
					<geosource-post-creator></geosource-post-creator>
<!-- 					<geosource-channel-creator
						on-submit="createChannel">
					</geosource-channel-creator> -->
				</div>
			</paper-header-panel>
		</geosource-dialog>

		<paper-dialog id="login_dialog" with-backdrop>
			<h2>Login</h2>
			<paper-dialog-scrollable>
				<div class="vertical layout">
					<a href="/api/auth/gplus">
					<paper-button class="signin google">
						<div class="horizontal layout center">
						<social-media-icons icon="googleplus" color="#fff"></social-media-icons>
						<div class="flex">Sign in with Google</div>
						</div>
					</paper-button>
					</a>
					<paper-button class="signin facebook">
						<div class="horizontal layout center">
						<social-media-icons icon="facebook" color="#fff"></social-media-icons>
						<div class="flex">Sign in with Facebook</div>
						</div>
					</paper-button>
					<paper-button class="signin twitter">
						<div class="horizontal layout center">
						<social-media-icons icon="twitter" color="#fff"></social-media-icons>
						<div class="flex">Sign in with Twitter</div>
						</div>
					</paper-button>
				</div>
			</paper-dialog-scrollable>
		</paper-dialog>

		<paper-drawer-panel id="drawer" drawer-width="{{drawerWidth}}" narrow="{{drawerShut}}"
			on-paper-responsive-change="resizeMap">
			<div drawer class="drawer">
				<paper-header-panel>
					<paper-toolbar>
						<paper-icon-button icon="settings" on-tap="toggleSettings"></paper-icon-button>
						<div class="drawer_title">GeoSource</div>
						<paper-icon-button icon="close" on-tap="toggleDrawer"></paper-icon-button>
					</paper-toolbar>
					<paper-drawer-panel id="settings" drawer-width="100%" force-narrow>
						<div main>
							<geosource-posts posts="{{posts}}" on-move-map="moveToPost" on-open-post="openPost"></geosource-posts>
						</div>
						<div drawer>
							<geosource-settings></geosource-settings>
						</div>
					</paper-drawer-panel>
				</paper-header-panel>
			</div>
			<div main>

				<paper-button id="menu" on-tap="toggleDrawer" hidden$="{{!drawerShut}}" raised>
					<div id="geosource_button">
						<iron-icon icon="menu"></iron-icon>
						<div class="drawer_title">GeoSource</div>
					</div>
				</paper-button>
				<paper-button id="login" on-tap="openLoginDialog" hidden$="{{loggedIn(userId)}}">Login</paper-button>
				<paper-button id="logout" on-tap="logout" hidden$="{{!loggedIn(userId)}}">Logout</paper-button>

				<paper-fab icon="add" id="add" on-tap="toggleChannelDialog"></paper-fab>
				<paper-fab icon="add" id="add2" on-tap="togglePostDialog"></paper-fab>

				<geosource-map id="map" posts="[[posts]]"></geosource-map>

			</div>
		</paper-drawer-panel>

	</template>
</dom-module>

<script>
	Polymer({
		is: "geosource-app",

		properties: {
			userId: {
				type: String,
			},
			state: {
				type: String,
			},
			posts: {
				type: Array,
				value: [],
			},
			user: {
				name: "Josh Heinrichs"
			},
			drawerWidth: {
				type: String,
				value: "400px"
			},
			drawerShut: {
				type: Boolean
			},
		},

		ready: function() {
			console.log(this.userId);
			this.updateLocation();
			this.$.api.getPosts();
		},

		loggedIn: function(userId) {
			return userId != "";
		},
		logout: function() {
			this.$.api.logout();
		},

		updateLocation: function() {
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(function(location) {
					this.$.map.updateCenter(location.coords);
				}.bind(this));
			} else {
				console.log("geolocation is not supported by this browser.");
			}
		},

		toggleSettings: function() {
			this.$.settings.togglePanel();
		},

		toggleDrawer: function() {
			var drawer = this.$.drawer;
			if (drawer.narrow) {
				drawer.forceNarrow = false;
				drawer.togglePanel();
			} else {
				drawer.forceNarrow = true;
				drawer.narrow = true;
			}
		},

		resizeMap: function() {
			var drawer = this.$.drawer;
			if (drawer.narrow && !drawer.forceNarrow) {
				this.drawerWidth = "90%";
			} else {
				this.drawerWidth = "400px";
			}
		},

		moveToPost: function(event, detail, sender) {
			this.$.map.updateCenter(detail.post.location);
		},

		toggleChannelDialog: function() {
			this.$.create_channel.toggle();
		},
		togglePostDialog: function() {
			this.$.create_post.toggle();
		},

		toggleUser: function() {
			this.$.user_dialog.toggle();
		},

		createChannel(event, detail, sender) {
			this.$.api.createChannel(detail.channel);
		},

		openCreateUserDialog: function(event, detail, sender) {
			console.log("opening dialog");
			this.$.create_user_dialog.open();
		},

		openLoginDialog: function() {
			this.$.login_dialog.open();
		},

		openPost: function(event, detail, sender) {
			console.log(detail);
			this.$.post.openPost(detail.postid);
		},
	});
</script>