<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/image-icons.html">

<dom-module id="post-creator">
	<style>
		paper-textarea {
			width: 200px;
		}
		.hidden {
			display: block;
			visibility: hidden;
			width: 0;
			height: 0;
			padding: 0;
			margin: 0;
		}
		img {
			height: 75px;
			margin: 15px;
			margin-left: 0;
			margin-bottom: 0;
		}
		paper-button {
			color: #000;
			background-color: #ddd;
			text-transform: none;
			margin: 0;
			display: block;
			width: 200px;
		}
		.title {
			font-size: 18px;
			font-weight: bold;
		}
		.contents {
			background-color: #eee;
			padding: 15px;
			margin-bottom: 15px;
		}
		paper-textarea {
			font-size: 14px;
			width: 100%;
		}
		paper-textarea::shadow paper-input-container {
			padding: 0;
		}
		paper-checkbox {
			padding: 0;
			margin-top: 10px;
		}
		paper-checkbox:first-child {
			margin-top: 0;
		}
		paper-radio-button {
			padding: 0;
			margin-top: 10px;
		}
		paper-radio-button:first-child {
			margin-top: 0;
		}
	</style>
	<template>
		<form id="form" enctype="multipart/form-data" action="/upload" method="post">
			
			<paper-button on-tap="addPost">Add Post</paper-button><br>
			<paper-button on-tap="removePostFromId">Remove Post</paper-button><paper-input id="idInput"></paper-input><br>
			<paper-button on-tap="clearPosts">Clear Posts</paper-button><br>
			<paper-button on-tap="displayPosts">Display Posts</paper-button><br>
			

			<div class="title"><b>Title</b></div>
			<div class="contents">
				<paper-textarea value="{{field-1}}" label="Input a title..." no-label-float></paper-textarea>
				<input class="hidden" type="text" name="field-1" value="{{field-1}}">
			</div>

			<div class="title"><b>Images</b></div>
			<div class="contents">
				<input class="hidden" id="file" name="field-2" type="file" capture="camera" accept="image/*" multiple on-change="getPosts">
				<paper-button id="select" on-tap="openFiles">
					<iron-icon icon="image:camera-alt"></iron-icon>
					<span>Add Pictures</span>
				</paper-button>
				<output id="list"></output>
			</div>

			<div class="title"><b>Check Boxes</b></div>
			<div class="contents">
				<paper-radio-group>
					<paper-checkbox name="option-1" checked="{{field-3-option-1}}">Option 1</paper-checkbox>
					<input class="hidden" type="checkbox" name="field-3" value="Option 1" checked="{{field-3-option-1}}">
					<paper-checkbox name="option-2" checked="{{field-3-option-2}}">Option 2</paper-checkbox>
					<input class="hidden" type="checkbox" name="field-3" value="Option 2" checked="{{field-3-option-2}}">
					<paper-checkbox name="option-3" checked="{{field-3-option-3}}">Option 3</paper-checkbox>
					<input class="hidden" type="checkbox" name="field-3" value="Option 3" checked="{{field-3-option-3}}">
				</paper-radio-group>
			</div>

			<div class="title"><b>Radio Buttons</b></div>
			<div class="contents">
				<paper-radio-group>
					<paper-radio-button name="option-1" checked="{{field-4-option-1}}">Option 1</paper-radio-button>
					<input class="hidden" type="radio" name="field-4" value="Option 1" checked="{{field-4-option-1}}">
					<paper-radio-button name="option-2" checked="{{field-4-option-2}}">Option 2</paper-radio-button>
					<input class="hidden" type="radio" name="field-4" value="Option 2" checked="{{field-4-option-2}}">
					<paper-radio-button name="option-3" checked="{{field-4-option-3}}">Option 3</paper-radio-button>
					<input class="hidden" type="radio" name="field-4" value="Option 3" checked="{{field-4-option-3}}">
				</paper-radio-group>
			</div>

			<input type="hidden" name="token" value="{{.}}">

			<paper-button on-tap="submit">Submit</paper-button>

			
		</form>
	</template>
</dom-module>

<script>
	Polymer({
		is: "post-creator",

		properties: {
			DB_NAME: {
				type: String,
				value: "geosource-indexeddb",
			},
			DB_VERSION: {
				type: Number,
				value: 2,
			},
			DB_STORE_NAME: {
				type: String,
				value: "posts",
			},
			db: Object,
		},

		ready: function() {
			this.openDb();
		},

		openDb: function() {
			console.log("openDb ...");
			var request = indexedDB.open(this.DB_NAME, this.DB_VERSION);
			request.onsuccess = function(event) {
				this.db = request.result;
				console.log("openDb DONE");
				this.displayPosts();
			}.bind(this);
			request.onerror = function(event) {
				console.error("openDb:", event.target.errorCode);
			}.bind(this);
			request.onupgradeneeded = function(event) {
				console.log("openDb.onupgradeneeded");
				var store = event.currentTarget.result.createObjectStore(
					this.DB_STORE_NAME, {keyPath: 'id', autoIncrement: true});
			}.bind(this);
		},

		getObjectStore: function(storeName, mode) {
			var transaction = this.db.transaction(storeName, mode);
			return transaction.objectStore(storeName);
		},

		clearPosts: function(storeName) {
			var store = this.getObjectStore(this.DB_STORE_NAME, "readwrite");
			var request = store.clear();
			request.onsuccess = function(event) {
				console.log("store cleared");
				// this.displayActionSuccess("Store cleared");
				// this.displayPubList(store);
			}.bind(this);
			request.onerror = function(event) {
				console.error("clearPosts", event.target.errorCode);
				this.displayActionFailure(request.error);
			}.bind(this);
		},

		addPost: function() {
			console.log("trying to insert");
			var store = this.getObjectStore(this.DB_STORE_NAME, "readwrite");
			var object = {blob: "ayy"};
			var request;
			try {
				request = store.add(object);
			} catch (e) {
				throw e;
			}
			request.onsuccess = function(event) {
				console.log("Insertion into DB successful");
			};
			request.onerror = function() {
				console.error("addPublication error", this.error);
			};
		},

		removePostFromId: function() {
			var id = parseInt(this.$.idInput.value);
			console.log("removing post", id);
			var store = this.getObjectStore(this.DB_STORE_NAME, "readwrite");
			this.removePost(id, store);
			// var request = store.index('id');
			// request.get(id).onsuccess = function(event) {
			// 	if (typeof event.target.result == "undefined") {
			// 		// this.displayActionFailture("No matching record found");
			// 		return;
			// 	}
			// 	this.removePost(event.target.result.id, store);
			// }.bind(this);
			// request.onerror = function(event) {
			// 	console.error("remove post", event.target.errorCode);
			// };
		},

		removePost: function(key, store) {
			var request = store.get(key);
			request.onsuccess = function(event) {
				var record = event.target.result;
				console.log("record:", record);
				if (typeof record == "undefined") {
					//displayActionFailure("No matching record found");
					return;
				}
				request = store.delete(key);
				request.onsuccess = function(event) {
					console.log("delete successful");
				};
				request.onerror = function(event) {
					console.error("deletePublication:", event.target.errorCode);
				};
			};
			request.onerror = function(event) {
				console.error("deletePublication:", event.target.errorCode);
			};
		},

		openFiles: function() {
			this.$.file.click();
		},

		getPosts: function() {
			Polymer.dom(this.$.list).innerHTML = "";

			var files = this.$.file.files;
			for (var i=0; i< files.length; i++) {
				var file = files[i];
				var reader = new FileReader();
				var blob = file.slice(0, file.size);
				this.storeFile(blob, "file-"+i);
				reader.onload = function(event) {
					var result = event.target.result;
					var img = new Image();
					img.src = result;
					Polymer.dom(this.$.list).appendChild(img);
				}.bind(this);
				reader.readAsDataURL(blob);
			}
		},

		storeFile: function(blob, index) {
			console.log("adding file");
			var transaction = this.db.transaction(["posts"], "readwrite");
			transaction.oncomplete = function(event) {
				alert("all done");
			};
			transaction.onerror = function(event) {
				console.log("error");
			};

			var objectStore = transaction.objectStore("posts");
			var request = objectStore.add(blob, index);
			request.onsuccess = function(event) {
				console.log("added file");
			};
		},

		displayPosts: function() {
			console.log("displayPubList");
			var store = this.getObjectStore(this.DB_STORE_NAME, "readonly");
			var request = store.count();
			request.onsuccess = function(event) {
				console.log(event.target.result);
			}.bind(this);
			request.onerror = function(event) {
				console.error("add error", request.error);
				this.displayActionFailure(request.error);
			}.bind(this);

			var i = 0;
			request = store.openCursor();
			request.onsuccess = function(event) {
				var cursor = event.target.result;
				if (cursor) {
					console.log("displayPubList cursor:", cursor);
					request = store.get(cursor.key);
					request.onsuccess = function(event) {
						console.log(event.target.result);
					};
					cursor.continue();
					i++;
				} else {
					console.log("No more entries");
				}
			};
		},

		submit: function() {
			var form = this.$.form;
			var formData = new FormData(form);
			var xhr = new XMLHttpRequest();
			xhr.open('POST', '/upload', true);
			xhr.send(formData);
		}
	});
</script>